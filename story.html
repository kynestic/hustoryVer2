<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="/assets/css/storyStyle.css">
        <script src="https://kit.fontawesome.com/4a24fc7d8b.js" crossorigin="anonymous"></script>
        <title>Đọc truyện online, đọc truyện hay</title>
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">

        <!-- jQuery library -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

        <!-- Latest compiled JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    </head>

    <body style="background-color: #F4F4F4;">
        <div id="wrap">
            <div id="nav">
                <div class="container">
                    <div class="logo"><a style="text-decoration: none; color: white;"  href="../home">HuStory</a></div>
                    <div class="controller">
                        <div class="category nav-button-wrapper">
                            <div class="nav-button">
                                <i class="fa-solid fa-list"></i>
                                Thể loại
                                <i class="fa-solid fa-caret-down"></i>
                            </div>
                            <div class="category-list nav-list">
                            <div class="">
                                <ul class="dropdown-list">
                                    <li><a href="../../search/category/4">Tiên Hiệp</a></li>
                                    <li><a href="../../search/category/5">Kiếm hiệp</a></li>
                                    <li><a href="../../search/category/7">Xuyên Không</a></li>
                                </ul>
                            </div>

                            <div class="">
                                <ul class="dropdown-list">
                                    <li><a href="../../search/category/8">Linh Dị</a></li>
                                    <li><a href="../../search/category/9">Trinh Thám</a></li>
                                    <li><a href="../../search/category/3">Đô Thị</a></li>
                                </ul>
                            </div>

                            <div class="">
                                <ul class="dropdown-list">
                                    <li><a href="../../search/category/1">Huyền Huyễn</a></li>
                                    <li><a href="../../search/category/2">Khoa Huyễn</a></li>
                                    <li><a href="../../search/category/6">Dị Giới</a></li>
                                </ul>
                            </div>
                        </div>
                        </div>

                        <div class="length nav-button-wrapper">
                            <div class="nav-button">
                                <i class="fa-solid fa-list"></i>
                                Độ dài
                                <i class="fa-solid fa-caret-down"></i>
                            </div>
                            <ul class="length-list nav-list dropdown-list">
                                <li><a href="">Dưới 100 chương</a></li>
                                <li><a href="">100-500 chương</a></li>
                                <li><a href="">500-1000 chương</a></li>
                                <li><a href="">Trên 1000 chương</a></li>
                            </ul>
                        </div>

                        <div class="setting nav-button-wrapper">
                            <div class="nav-button">
                                <i class="fa-solid fa-list"></i>
                                Cài đặt
                                <i class="fa-solid fa-caret-down"></i>
                            </div>

                            <ul class="setting-list nav-list dropdown-list">
                                <li>
                                    <a>
                                        <label for="dark-mode">
                                            <i class="fa-solid fa-moon"></i>
                                            Darkmode
                                        </label>
                                        <input type="radio" name="theme" id="dark-mode">
                                    </a>
                                </li>
                                <li>
                                    <a>
                                        <label for="light-mode">
                                            <i class="fa-solid fa-sun"></i>
                                            Lightmode
                                        </label>
                                        <input type="radio" name="theme" id="light-mode">
                                    </a>
                                </li>
                            </ul>
                        </div>

                        <div class="search-box nav-button-wrapper">
                            <div class="search-input">
                                <input id ="searchInput" type="text" placeholder="Tìm truyện...">
                            </div>
                            <div class="search-button">
                                <a id="searchButton"><i class="fa-solid fa-magnifying-glass"></i></a>
                            </div>
                        </div>

                        <div class="user-box nav-button-wrapper">
                            <div class="nav-button">Đăng ký</div>
                            <div class="nav-button">Đăng nhập</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="story">
                <div class="container">
                    <div class="story-main">
                        <div class="header">
                            <div class="header-title">
                                Thông tin truyện
                            </div>
                        </div>
                        <div class="story-main-wrapper">
                            <div class="story-info">
                                <img src="" alt="" class="cover">
                                <div class="info">
                                    <div class="story-author">
                                        <h3>Tác giả: </h3> 
                                        <a href="" class="source"></a>
                                    </div>
                                    <div class="story-category">
                                        <h3>Thể loại: </h3> 
                                    </div>
                                    <div class="story-status">
                                        <h3>Trạng thái: </h3> 
                                        <span class="source"></span>
                                    </div>
                                </div>
                            </div>
    
                            <div class="story-desc">
                                <div class="story-title"></div>
                                <div class="story-rating">
                                    <div class="rate-holder" data-score="7.5" style="cursor: pointer;">
                                        <img alt="1" src="//static.8cache.com/lib/raty/images/star-on.png" title="Không còn gì để nói...">
                                        <img alt="2" src="//static.8cache.com/lib/raty/images/star-on.png" title="WTF">
                                        <img alt="3" src="//static.8cache.com/lib/raty/images/star-on.png" title="Cái gì thế này ?!">
                                        <img alt="4" src="//static.8cache.com/lib/raty/images/star-on.png" title="Haizz">
                                        <img alt="5" src="//static.8cache.com/lib/raty/images/star-on.png" title="Tạm">
                                        <img alt="6" src="//static.8cache.com/lib/raty/images/star-on.png" title="Cũng được">
                                        <img alt="7" src="//static.8cache.com/lib/raty/images/star-on.png" title="Khá đấy">
                                        <img alt="8" src="//static.8cache.com/lib/raty/images/star-half.png" title="Được">
                                        <img alt="9" src="//static.8cache.com/lib/raty/images/star-off.png" title="Hay">
                                        <img alt="10" src="//static.8cache.com/lib/raty/images/star-off.png" title="Tuyệt đỉnh!">
                                        <input name="score" type="hidden" value="7.5">
                                    </div>
                                    <div class="rating">
                                        Đánh giá: 
                                        <strong class="score"></strong>
                                        /10 từ <strong class="rating-count"> 5463 Lượt</strong>
                                    </div>
                                </div>
                                <div class="story-intro">
                                    <div id="demo" class="desc-text collapse" aria-expanded="false" itemprop="description">
                                    </div>

                                    <button type="button" class="btn btn-info" data-toggle="collapse" data-target="#demo">Xem thêm</button>
                                </div>
                                <div class="story-newest-chapter">
                                    <div class="header">
                                        <div class="header-title">Các chương mới nhất</div>
                                    </div>
                                    <div class="newest-chapter-wrapper">
                                        <ul>
                                            <li class="newest-chapter-1"><i class="fa-solid fa-angle-right"></i><a href=""></a></li>
                                            <li class="newest-chapter-2"><i class="fa-solid fa-angle-right"></i><a href=""></a></li>
                                            <li class="newest-chapter-3"><i class="fa-solid fa-angle-right"></i><a href=""></a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="story-chapter-list">
                            <div class="header">
                                <div class="header-title">
                                    Danh sách chương
                                </div>
                            </div>

                            <div class="chapter-list-wrapper">
                                <ul>
                                    <li><a href=""></a></li>
                                    
                                </ul>

                                
                            </div>
                        </div>
                        
                    </div>

                    <div class="story-side">
                        <div class="same-author">
                            <div class="header">
                                <div class="header-title">
                                    Cùng tác giả
                                </div>
                            </div>

                            <div class="same-author-story">
                                <ul>
                                    <li><i class="fa-solid fa-angle-right"></i><a href=""> Huyết Trùng Tiên Khung</a></li>
                                    <li><i class="fa-solid fa-angle-right"></i><a href=""> Linh Vũ Thiên Hạ</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="story-popular">
                            <div class="header">
                                <div class="header-title">
                                    Truyện đang hot
                                </div>
                            </div>
                            <div class="popular-table">
                                <div class="popular-table-option">
                                    <!-- <ul>
                                        <li><a href="">Ngày</a></li>
                                        <li><a href="">Tháng</a></li>
                                        <li><a href="">Năm</a></li>
                                    </ul> -->
                                </div>
                                <div class="popular-table-content">
                                    <div class="popular-table-item">
                                        <div class="rank" id="1-popular">
                                            1
                                        </div>
    
                                        <div class="table-item-content">
                                            <div class="table-item-name">
                                                <a href="./chapter.html"></a>
                                            </div>
    
                                            <div class="table-item-category">
                                                
                                            </div>
                                        </div>
                                    </div>

                                    <div class="popular-table-item">
                                        <div class="rank" id="2-popular">
                                            2
                                        </div>
    
                                        <div class="table-item-content">
                                            <div class="table-item-name">
                                                <a href="./chapter.html"></a>
                                            </div>
    
                                            <div class="table-item-category">
                                                
                                            </div>
                                        </div>
                                    </div>

                                    <div class="popular-table-item">
                                        <div class="rank" id="3-popular">
                                            3
                                        </div>
    
                                        <div class="table-item-content">
                                            <div class="table-item-name">
                                                <a href="./chapter.html"></a>
                                            </div>
    
                                            <div class="table-item-category">
                                                
                                            </div>
                                        </div>
                                    </div>

                                    <div class="popular-table-item">
                                        <div class="rank" id="4-popular">
                                            4
                                        </div>
    
                                        <div class="table-item-content">
                                            <div class="table-item-name">
                                                <a href="./chapter.html"></a>
                                            </div>
    
                                            <div class="table-item-category">
                                                
                                            </div>
                                        </div>
                                    </div>

                                    <div class="popular-table-item">
                                        <div class="rank" id="5-popular">
                                            5
                                        </div>
    
                                        <div class="table-item-content">
                                            <div class="table-item-name">
                                                <a href="./chapter.html"></a>
                                            </div>
    
                                            <div class="table-item-category">
                                                
                                            </div>
                                        </div>
                                    </div>

                                    <div class="popular-table-item">
                                        <div class="rank" id="6-popular">
                                            6
                                        </div>
    
                                        <div class="table-item-content">
                                            <div class="table-item-name">
                                                <a href="./chapter.html"></a>
                                            </div>
    
                                            <div class="table-item-category">
                                                
                                            </div>
                                        </div>
                                    </div>

                                    <div class="popular-table-item">
                                        <div class="rank" id="7-popular">
                                            7
                                        </div>
    
                                        <div class="table-item-content">
                                            <div class="table-item-name">
                                                <a href="./chapter.html"></a>
                                            </div>
    
                                            <div class="table-item-category">
                                                
                                            </div>
                                        </div>
                                    </div>

                                    <div class="popular-table-item">
                                        <div class="rank" id="8-popular">
                                            8
                                        </div>
    
                                        <div class="table-item-content">
                                            <div class="table-item-name">
                                                <a href="./chapter.html"></a>
                                            </div>
    
                                            <div class="table-item-category">
                                                
                                            </div>
                                        </div>
                                    </div>

                                    <div class="popular-table-item">
                                        <div class="rank" id="9-popular">
                                            9
                                        </div>
    
                                        <div class="table-item-content">
                                            <div class="table-item-name">
                                                <a href="./chapter.html"></a>
                                            </div>
    
                                            <div class="table-item-category">
                                                
                                            </div>
                                        </div>
                                    </div>

                                    <div class="popular-table-item">
                                        <div class="rank" id="10-popular">
                                            10
                                        </div>
    
                                        <div class="table-item-content">
                                            <div class="table-item-name">
                                                <a href="./chapter.html"></a>
                                            </div>
    
                                            <div class="table-item-category">
                                                
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="footer"></div>
        <script>
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
        
            searchButton.onclick = function(){
                let searchValue = searchInput.value;
                searchValue = searchValue.replace(/ +(?= )/g,'');
                if (searchValue)
                window.location.href = '../' + 'search/' + searchValue;
            }


            const currentURL = window.location.href;

            const urlObject = new URL(currentURL);

            const id = urlObject.pathname.split('/')[2]; // Giả sử rằng '/story/:id' là route và :id là tham số thứ hai trong path


            


            fetch('/story/getStory/'+ id)
                .then(response => response.json())
                .then(story => {
                    let img = document.querySelector('.story-main-wrapper .story-info img');
                    img.src = story.storyImg;

                    let author = document.querySelector('.story-main-wrapper .story-info .info .story-author a')
                    author.innerHTML = story.storyAuthor;

                    let status = document.querySelector('.story-main-wrapper .story-info .info .story-status span');
                    status.innerHTML = story.storyStatus;

                    let title = document.querySelector('.story-desc .story-title');
                    title.innerHTML = story.storyName;

                    let rating = document.querySelector('.story-desc .story-rating .rating .score');
                    rating.innerHTML = story.storyRating;

                    let demo = document.getElementById('demo');
                    demo.innerHTML = story.storyIntro.replace().replace(/\n/g, "<br>");
                    fetch('/story/getCategory/' + id)
                        .then(response => response.json())
                        .then(list => {
                            let wrapper = document.querySelector('.story-category');
                            const listItem = Object.values(list.categories);
                            // Xóa hết các phần tử con trong wrapper
                            //wrapper.innerHTML = '';
                        
                            // Duyệt qua mảng listItem để tạo các phần tử <a>
                                for (let i = 0; i < listItem.length; i++) {
                                    // Tạo phần tử <a>
                                        console.log(listItem);
                                    let tmp = document.createElement('a');
                                    tmp.innerHTML = listItem[i];
                                    
                                    // Nếu là phần tử đầu tiên, không thêm dấu phẩy
                                    if (i === 0) {
                                        wrapper.appendChild(tmp);
                                    } else {
                                        // Thêm dấu phẩy và khoảng trắng trước mỗi phần tử từ thứ hai trở đi
                                        wrapper.appendChild(document.createTextNode(', '));
                                        wrapper.appendChild(tmp);
                                    }
                                }
                        })
                        .catch(error => {
                            console.error('There was a problem with the fetch operation:', error);
                        });
                    
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                });
            let count = 1;
            fetch('/story/getLatest/'+ id)
                .then(response => response.json())
                .then(chapters=>{
                    for (let i = 0; i <= 3; i++) {
                        let ele = document.querySelector('.newest-chapter-' +  count);
                        count++;
                        ele = ele.lastChild;
                        ele.innerHTML = 'Chương '+ chapters[i].chapterNumber +": " + chapters[i].chapterName;
                        let src = './'+ id+ '/chapter/' + chapters[i].chapterId;
                        ele.href = src;
                    };
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                })

            fetch('/story/getChapter/'+ id)
                .then(response => response.json())
                .then(chapters=>{
                    
                    for (let i = 0; chapters[i]; i++) {

                        let parent = document.querySelector('.chapter-list-wrapper ul');
                        let ele = document.createElement('li');
                        ele.appendChild( document.createElement('a'));
                        ele.style.listStyle = 'none';
                        ele.style.display = 'block';

                        let sub = ele.firstElementChild;
                        sub.style.color = 'black';
                        sub.style.display = 'inline-block';
                        sub.style.padding = '4px';
                        sub.attributes='color: black; display: inline-block; padding: 4px;';
                        
                        sub.innerText = 'Chương '+ chapters[i].chapterNumber +": " + chapters[i].chapterName;
                        let src = './'+ id+ '/chapter/' + chapters[i].chapterId;
                        sub.href = src;

                        parent.appendChild(ele);
                    };
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                })

            fetch('/popular')
                .then(response => response.json())
                .then(chapters=>{
                    for (let i = 1; i <= 10; i++) {
                        let tmp = document.getElementById(''+ i + '-popular');
                        tmp = tmp.nextElementSibling;
                        tmp = tmp.firstElementChild;
                        console.log(chapters[i-1].storyName);
                        (tmp.firstElementChild).innerHTML = chapters[i - 1].storyName;
                        (tmp.firstElementChild).href = '../' + 'story/' + chapters[i - 1].storyId;
                        tmp.firstChild.href="";
                        tmp = tmp.nextElementSibling;

                        fetch('/story/getCategory/' + chapters[i - 1].storyId)
                            .then(response => response.json())
                            .then(list => {
                                const listItem = Object.values(list.categories);
                                // Xóa hết các phần tử con trong wrapper
                                //wrapper.innerHTML = '';
                            
                                // Duyệt qua mảng listItem để tạo các phần tử <a>
                                    for (let i = 0; i < 3 && listItem[i]; i++) {
                                        // Tạo phần tử <a>
                                        let ele = document.createElement('a');
                                        ele.innerHTML = listItem[i];
                                        
                                        // Nếu là phần tử đầu tiên, không thêm dấu phẩy
                                        if (i === 0) {
                                            tmp.appendChild(ele);
                                        } else {
                                            // Thêm dấu phẩy và khoảng trắng trước mỗi phần tử từ thứ hai trở đi
                                            tmp.appendChild(document.createTextNode(', '));
                                            tmp.appendChild(ele);
                                        }
                                    }
                            })
                            .catch(error => {
                                console.error('There was a problem with the fetch operation:', error);
                            });
                    };
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                })
        </script>

    </body>

</html>